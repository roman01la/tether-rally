<!doctype html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Tether Rally - Admin</title>
		<style>
			:root {
				--color-success: #40916c;
				--color-success-light: #52b788;
				--color-success-dark: #2d6a4f;
				--color-error: #e63946;
				--color-error-light: #ff6b6b;
				--color-error-dark: #9d0208;
				--color-kick: #b91c1c;
				--color-kick-light: #dc2626;
				--color-youtube: #ff0000;
				--color-youtube-dark: #cc0000;
				--color-bg-dark: #1a1a2e;
				--color-bg-card: #16213e;
				--color-border: #3a3a5a;
				--color-border-light: #5a5a8a;
				--color-text-muted: #888;
				--color-text-dim: #666;
				--color-btn-disabled: #3a3a5a;
				--color-message-bg: #2a2a4a;
			}
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			body {
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
				background: var(--color-bg-dark);
				color: #eee;
				min-height: 100vh;
				padding: 40px 20px;
			}
			h1 {
				font-size: 24px;
				font-weight: 300;
				color: var(--color-text-muted);
				margin-bottom: 30px;
			}
			/* Grid Layout */
			.main-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 40px;
				max-width: 900px;
				margin: 0 auto;
			}
			.column {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
			@media (max-width: 768px) {
				.main-grid {
					grid-template-columns: 1fr;
					gap: 20px;
				}
			}
			.status-card {
				background: var(--color-bg-card);
				border-radius: 12px;
				padding: 20px;
				margin-bottom: 20px;
				width: 100%;
				max-width: 400px;
			}
			.status-row {
				display: flex;
				justify-content: space-between;
				padding: 8px 0;
				border-bottom: 1px solid var(--color-message-bg);
			}
			.status-row:last-child {
				border-bottom: none;
			}
			.status-label {
				color: var(--color-text-muted);
			}
			.status-value {
				font-weight: 600;
			}
			.status-value.online {
				color: var(--color-success);
			}
			.status-value.offline {
				color: var(--color-error);
			}
			.btn {
				padding: 16px 40px;
				font-size: 18px;
				border: none;
				border-radius: 12px;
				cursor: pointer;
				font-weight: 600;
				margin: 10px;
				min-width: 200px;
			}
			.btn:disabled {
				background: var(--color-btn-disabled);
				cursor: not-allowed;
			}
			.btn-start {
				background: var(--color-success);
				color: white;
			}
			.btn-start:hover:not(:disabled) {
				background: var(--color-success-light);
			}
			.btn-stop {
				background: var(--color-error);
				color: white;
			}
			.btn-stop:hover:not(:disabled) {
				background: var(--color-error-light);
			}
			.btn-kick {
				background: var(--color-kick);
				color: white;
				min-width: 80px;
				padding: 8px 16px;
				font-size: 14px;
			}
			.btn-kick:hover:not(:disabled) {
				background: var(--color-kick-light);
			}
			.btn-youtube {
				background: var(--color-youtube);
				color: white;
				min-width: 120px;
				padding: 12px 20px;
				font-size: 14px;
			}
			.btn-youtube:hover:not(:disabled) {
				background: var(--color-youtube-dark);
			}
			.btn-youtube-stop {
				background: #666;
			}
			.btn-youtube-stop:hover {
				background: #888;
			}
			.youtube-status {
				display: flex;
				align-items: center;
				gap: 8px;
			}
			.live-indicator {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				background: var(--color-text-dim);
			}
			.live-indicator.live {
				background: var(--color-youtube);
				animation: pulse 1s ease-in-out infinite;
			}
			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}
			.race-time {
				font-size: 48px;
				font-weight: 700;
				font-family: monospace;
				margin: 30px 0;
				color: var(--color-success);
			}
			.message {
				margin-top: 20px;
				padding: 12px 20px;
				border-radius: 8px;
				background: var(--color-message-bg);
			}
			.message.success {
				background: var(--color-success-dark);
			}
			.message.error {
				background: var(--color-error-dark);
			}

			/* Token Generator */
			.section-title {
				font-size: 18px;
				font-weight: 300;
				color: var(--color-text-muted);
				margin: 0 0 20px 0;
			}
			.section-title:not(:first-child) {
				margin-top: 30px;
			}
			.token-card {
				background: var(--color-bg-card);
				border-radius: 12px;
				padding: 20px;
				width: 100%;
				max-width: 400px;
			}
			.token-row {
				display: flex;
				gap: 10px;
				margin-bottom: 15px;
			}
			.token-select {
				flex: 1;
				padding: 12px;
				font-size: 14px;
				border: 2px solid var(--color-border);
				border-radius: 8px;
				background: var(--color-bg-dark);
				color: #eee;
			}
			.btn-generate {
				background: #3a3a7a;
				color: white;
				padding: 12px 20px;
				font-size: 14px;
				min-width: auto;
			}
			.btn-generate:hover {
				background: #4a4a9a;
			}
			.token-output {
				background: var(--color-bg-dark);
				border: 2px solid var(--color-border);
				border-radius: 8px;
				padding: 15px;
				font-family: monospace;
				font-size: 14px;
				word-break: break-all;
				color: var(--color-success);
				min-height: 50px;
				cursor: pointer;
				position: relative;
			}
			.token-output:hover {
				border-color: var(--color-border-light);
			}
			.token-output .hint {
				color: var(--color-text-dim);
				font-size: 12px;
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
			}
			.token-expires {
				margin-top: 10px;
				font-size: 12px;
				color: var(--color-text-muted);
			}
			.copy-feedback {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: rgba(64, 145, 108, 0.9);
				padding: 8px 16px;
				border-radius: 6px;
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
				animation: fadeOut 1s ease-out forwards;
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				70% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			/* Header with help button */
			.header {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 15px;
				margin-bottom: 30px;
			}
			.header h1 {
				margin-bottom: 0;
			}
			.btn-help {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				border: 2px solid var(--color-border);
				background: var(--color-bg-card);
				color: var(--color-text-muted);
				font-size: 16px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.2s;
			}
			.btn-help:hover {
				border-color: var(--color-border-light);
				color: #eee;
				background: #1a2a4e;
			}
			/* Modal */
			.modal-overlay {
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.8);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 1000;
				opacity: 0;
				visibility: hidden;
				transition:
					opacity 0.2s,
					visibility 0.2s;
			}
			.modal-overlay.active {
				opacity: 1;
				visibility: visible;
			}
			.modal {
				max-width: 450px;
				max-height: 80vh;
				overflow-y: auto;
				margin: 20px;
				padding: 24px;
				background: var(--color-bg-card);
				border-radius: 12px;
				text-align: left;
				position: relative;
			}
			.modal-close {
				position: absolute;
				top: 16px;
				right: 16px;
				width: 28px;
				height: 28px;
				border-radius: 50%;
				border: none;
				background: var(--color-message-bg);
				color: var(--color-text-muted);
				font-size: 18px;
				cursor: pointer;
				line-height: 1;
			}
			.modal-close:hover {
				background: var(--color-border);
				color: #eee;
			}
			.instructions {
				text-align: left;
			}
			.instructions h2 {
				font-size: 18px;
				font-weight: 600;
				color: #eee;
				margin-bottom: 20px;
				padding-right: 30px;
			}
			.instructions h3 {
				font-size: 14px;
				font-weight: 600;
				color: #aaa;
				margin: 15px 0 8px 0;
			}
			.instructions ol,
			.instructions ul {
				margin: 0 0 10px 20px;
				font-size: 13px;
				color: var(--color-text-muted);
				line-height: 1.6;
			}
			.instructions li {
				margin-bottom: 6px;
			}
			.instructions code {
				background: var(--color-bg-dark);
				padding: 2px 6px;
				border-radius: 4px;
				font-size: 12px;
				color: var(--color-success);
			}
			.instructions .note {
				font-size: 12px;
				color: var(--color-text-dim);
				font-style: italic;
				margin-top: 10px;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>üèéÔ∏è Race Admin</h1>
			<button class="btn-help" onclick="openHelpModal()" title="Help">?</button>
		</div>

		<div class="main-grid">
			<!-- Left Column: Race Controls -->
			<div class="column">
				<div class="status-card">
					<div class="status-row">
						<span class="status-label">TX</span>
						<span id="esp32-status" class="status-value offline">--</span>
					</div>
					<div class="status-row">
						<span class="status-label">Player Connected</span>
						<span style="display: flex; align-items: center; gap: 10px">
							<span id="player-status" class="status-value offline">No</span>
							<button class="btn btn-kick" id="kick-btn" onclick="kickPlayer()" disabled>Kick</button>
						</span>
					</div>
					<div class="status-row">
						<span class="status-label">Video Feed</span>
						<span id="video-status" class="status-value offline">No</span>
					</div>
					<div class="status-row">
						<span class="status-label">Player Ready</span>
						<span id="ready-status" class="status-value offline">No</span>
					</div>
				</div>

				<div class="race-time" id="race-time">00:00.000</div>

				<div style="text-align: center">
					<button class="btn btn-start" id="start-btn" onclick="startRace()">Start Race</button>
					<button class="btn btn-stop" id="stop-btn" onclick="stopRace()">Stop</button>
				</div>

				<div id="message" class="message" style="display: none"></div>
			</div>

			<!-- Right Column: YouTube & Tokens -->
			<div class="column">
				<h2 class="section-title">üîë Token Generator</h2>

				<div class="token-card">
					<div class="token-row">
						<select id="token-duration" class="token-select">
							<option value="15">15 minutes</option>
							<option value="30">30 minutes</option>
							<option value="60" selected>1 hour</option>
							<option value="120">2 hours</option>
							<option value="480">8 hours</option>
							<option value="1440">24 hours</option>
						</select>
						<button class="btn btn-generate" onclick="generateToken()">Generate</button>
					</div>
					<div id="token-output" class="token-output" onclick="copyToken()">
						<span class="hint">Click "Generate" to create a token</span>
					</div>
					<div id="token-expires" class="token-expires"></div>
				</div>

				<h2 class="section-title">üé¨ YouTube Stream</h2>

				<div class="status-card">
					<div class="status-row">
						<span class="status-label">Stream Status</span>
						<span class="youtube-status">
							<span class="live-indicator" id="youtube-indicator"></span>
							<span id="youtube-status">Offline</span>
						</span>
					</div>
					<div class="status-row" style="justify-content: center; padding-top: 15px">
						<button class="btn btn-youtube" id="youtube-start-btn" onclick="startYouTubeStream()">‚ñ∂ Go Live</button>
						<button class="btn btn-youtube btn-youtube-stop" id="youtube-stop-btn" onclick="stopYouTubeStream()" disabled>‚èπ Stop</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Help Modal -->
		<div class="modal-overlay" id="help-modal" onclick="closeHelpModal(event)">
			<div class="modal" onclick="event.stopPropagation()">
				<button class="modal-close" onclick="closeHelpModal()">&times;</button>
				<div class="instructions">
					<h2>üìã Admin Instructions</h2>

					<h3>üöÄ Running a Race Session</h3>
					<ol>
						<li>Generate an access token and send it to the player</li>
						<li>Wait for player to connect (status shows <code>Player Connected: Yes</code>)</li>
						<li>Wait for video feed to establish (<code>Video Feed: Yes</code>)</li>
						<li>Player clicks "Ready" in their UI (<code>Player Ready: Yes</code>)</li>
						<li>Click <strong>Start Race</strong> ‚Äî 3 second countdown begins</li>
						<li>Timer starts after countdown, race is live!</li>
						<li>Click <strong>Stop</strong> when race is complete</li>
						<li><strong>Kick</strong> ‚Äî Disconnects player and revokes their token</li>
					</ol>

					<h3>‚öôÔ∏è Status Indicators</h3>
					<ul>
						<li><strong>TX</strong> ‚Äî Shows IP if RC car controller is connected</li>
						<li><strong>Player Connected</strong> ‚Äî Player connected</li>
						<li><strong>Video Feed</strong> ‚Äî video stream active</li>
						<li><strong>Player Ready</strong> ‚Äî Player confirmed ready to race</li>
					</ul>

					<h3>üé¨ YouTube Streaming</h3>
					<ul>
						<li>Click <strong>Go Live</strong> to start restreaming to YouTube</li>
						<li>Stream uses the configured RTMP key</li>
					</ul>
				</div>
			</div>
		</div>

		<!-- Optional: Load config.js for deployment-specific URLs -->
		<script src="config.js" onerror="console.log('No config.js found, using defaults')"></script>

		<script>
			// Control Relay URL (via Cloudflare Tunnel in production)
			const CONTROL_URL = window.CONTROL_URL || '';

			// YouTube Restreamer (Fly.io)
			const RESTREAMER_URL = window.RESTREAMER_URL || '';
			const RESTREAMER_SECRET = window.RESTREAMER_SECRET || '';

			// ===== TIMING CONSTANTS =====
			const STATUS_CHECK_INTERVAL_MS = 2000;
			const YOUTUBE_STATUS_INTERVAL_MS = 5000;
			const MESSAGE_DISPLAY_MS = 3000;
			const RACE_COUNTDOWN_MS = 3000;
			const YOUTUBE_START_DELAY_MS = 2000;
			const YOUTUBE_STOP_DELAY_MS = 1000;
			// ============================

			// ===== CACHED DOM ELEMENTS =====
			const raceTimeEl = document.getElementById('race-time');
			const messageEl = document.getElementById('message');
			const esp32StatusEl = document.getElementById('esp32-status');
			const playerStatusEl = document.getElementById('player-status');
			const videoStatusEl = document.getElementById('video-status');
			const readyStatusEl = document.getElementById('ready-status');
			const startBtn = document.getElementById('start-btn');
			const kickBtn = document.getElementById('kick-btn');
			const youtubeStatusEl = document.getElementById('youtube-status');
			const youtubeIndicator = document.getElementById('youtube-indicator');
			const youtubeStartBtn = document.getElementById('youtube-start-btn');
			const youtubeStopBtn = document.getElementById('youtube-stop-btn');
			// ===============================

			// ===== HELPER FUNCTIONS =====
			// Format milliseconds to MM:SS.mmm
			function formatTime(ms) {
				const mins = Math.floor(ms / 60000);
				const secs = Math.floor((ms % 60000) / 1000);
				const millis = ms % 1000;
				return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(millis).padStart(3, '0')}`;
			}

			// Update a status element with value and online/offline styling
			function updateStatusEl(el, value, isOnline) {
				el.textContent = value;
				el.className = 'status-value ' + (isOnline ? 'online' : 'offline');
			}
			// ============================

			let raceStartTime = null;
			let timerInterval = null;
			let youtubeStreaming = false;

			// ===== YouTube Streaming =====
			async function updateYouTubeStatus() {
				try {
					const res = await fetch(`${RESTREAMER_URL}/status`);
					const data = await res.json();
					youtubeStreaming = data.streaming;

					youtubeStatusEl.textContent = data.streaming ? 'LIVE' : 'Offline';
					youtubeIndicator.className = 'live-indicator' + (data.streaming ? ' live' : '');
					youtubeStartBtn.disabled = data.streaming;
					youtubeStopBtn.disabled = !data.streaming;
				} catch (e) {
					youtubeStatusEl.textContent = 'Error';
					console.error('YouTube status error:', e);
				}
			}

			async function startYouTubeStream() {
				if (!RESTREAMER_SECRET) {
					showMessage('RESTREAMER_SECRET not configured', true);
					return;
				}

				youtubeStartBtn.disabled = true;
				youtubeStatusEl.textContent = 'Starting...';

				try {
					const res = await fetch(`${RESTREAMER_URL}/start`, {
						method: 'POST',
						headers: { Authorization: `Bearer ${RESTREAMER_SECRET}` },
					});
					const data = await res.json();

					if (data.started) {
						showMessage('YouTube stream started!');
						setTimeout(updateYouTubeStatus, YOUTUBE_START_DELAY_MS);
					} else {
						showMessage(data.error || 'Failed to start stream', true);
						updateYouTubeStatus();
					}
				} catch (e) {
					showMessage('Failed to start YouTube stream: ' + e.message, true);
					updateYouTubeStatus();
				}
			}

			async function stopYouTubeStream() {
				if (!RESTREAMER_SECRET) {
					showMessage('RESTREAMER_SECRET not configured', true);
					return;
				}

				youtubeStopBtn.disabled = true;
				youtubeStatusEl.textContent = 'Stopping...';

				try {
					const res = await fetch(`${RESTREAMER_URL}/stop`, {
						method: 'POST',
						headers: { Authorization: `Bearer ${RESTREAMER_SECRET}` },
					});
					const data = await res.json();

					if (data.stopped) {
						showMessage('YouTube stream stopped');
					}
					setTimeout(updateYouTubeStatus, YOUTUBE_STOP_DELAY_MS);
				} catch (e) {
					showMessage('Failed to stop YouTube stream: ' + e.message, true);
					updateYouTubeStatus();
				}
			}

			async function updateStatus() {
				try {
					const res = await fetch(`${CONTROL_URL}/control/health`);
					const data = await res.json();

					updateStatusEl(esp32StatusEl, data.esp32_ip || 'Not found', !!data.esp32_ip);
					updateStatusEl(playerStatusEl, data.channel_open ? 'Yes' : 'No', data.channel_open);
					updateStatusEl(videoStatusEl, data.video_connected ? 'Yes' : 'No', data.video_connected);
					updateStatusEl(readyStatusEl, data.player_ready ? 'Yes' : 'No', data.player_ready);

					// Only enable start when player is ready (has video + clicked ready)
					startBtn.disabled = !data.player_ready;
					kickBtn.disabled = !data.channel_open;
				} catch (e) {
					console.error('Status check failed:', e);
				}
			}

			function showMessage(text, isError = false) {
				messageEl.textContent = text;
				messageEl.className = 'message ' + (isError ? 'error' : 'success');
				messageEl.style.display = 'block';
				setTimeout(() => (messageEl.style.display = 'none'), MESSAGE_DISPLAY_MS);
			}

			function updateTimer() {
				if (!raceStartTime) return;
				const elapsed = Date.now() - raceStartTime;
				raceTimeEl.textContent = formatTime(elapsed);
			}

			async function startRace() {
				try {
					const res = await fetch(`${CONTROL_URL}/admin/start-race`, { method: 'POST' });
					const data = await res.json();

					if (data.success) {
						showMessage('Race countdown started!');
						// Start timer after 3 second countdown
						setTimeout(() => {
							raceStartTime = Date.now();
							timerInterval = setInterval(updateTimer, 50);
						}, RACE_COUNTDOWN_MS);
					} else {
						showMessage(data.error || 'Failed to start race', true);
					}
				} catch (e) {
					showMessage('Failed to start race: ' + e.message, true);
				}
			}

			async function stopRace() {
				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}

				try {
					const res = await fetch(`${CONTROL_URL}/admin/stop-race`, { method: 'POST' });
					showMessage('Race stopped');
				} catch (e) {
					console.error('Stop race error:', e);
				}
			}
			async function kickPlayer() {
				if (!confirm('Kick player and revoke their token?')) return;

				// Stop timer if running
				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}
				raceStartTime = null;
				raceTimeEl.textContent = '00:00.000';

				try {
					const res = await fetch(`${CONTROL_URL}/admin/kick-player`, { method: 'POST' });
					const data = await res.json();

					if (data.success) {
						showMessage('Player kicked & token revoked');
						updateStatus(); // Refresh status immediately
					} else {
						showMessage(data.error || 'Failed to kick player', true);
					}
				} catch (e) {
					showMessage('Failed to kick player: ' + e.message, true);
				}
			}
			// Update status every 2 seconds
			updateStatus();
			setInterval(updateStatus, STATUS_CHECK_INTERVAL_MS);

			// Update YouTube status every 5 seconds
			updateYouTubeStatus();
			setInterval(updateYouTubeStatus, YOUTUBE_STATUS_INTERVAL_MS);

			// ===== Token Generator =====
			let currentToken = null;

			async function generateToken() {
				const minutes = parseInt(document.getElementById('token-duration').value);
				const outputEl = document.getElementById('token-output');
				const expiresEl = document.getElementById('token-expires');

				outputEl.innerHTML = '<span class="hint">Generating...</span>';
				expiresEl.textContent = '';

				try {
					const res = await fetch('/admin/generate-token', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ minutes }),
					});

					if (!res.ok) {
						throw new Error('Failed to generate token');
					}

					const data = await res.json();
					currentToken = data.token;
					outputEl.textContent = data.token;

					const expiresDate = new Date(data.expiresAt);
					expiresEl.textContent = `Expires: ${expiresDate.toLocaleString()}`;
				} catch (e) {
					outputEl.innerHTML = '<span class="hint" style="color: #e63946;">Error generating token</span>';
					console.error('Token generation error:', e);
				}
			}

			function copyToken() {
				if (!currentToken) return;

				navigator.clipboard.writeText(currentToken).then(() => {
					const outputEl = document.getElementById('token-output');
					const feedback = document.createElement('div');
					feedback.className = 'copy-feedback';
					feedback.textContent = 'Copied!';
					outputEl.appendChild(feedback);
					setTimeout(() => feedback.remove(), 1000);
				});
			}

			// ===== Help Modal =====
			function openHelpModal() {
				document.getElementById('help-modal').classList.add('active');
			}

			function closeHelpModal(event) {
				if (!event || event.target === event.currentTarget) {
					document.getElementById('help-modal').classList.remove('active');
				}
			}

			// Close modal on Escape key
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape') closeHelpModal();
			});
		</script>
	</body>
</html>
