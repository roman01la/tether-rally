<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Tether Rally - Admin</title>
		<style>
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			body {
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
				background: #1a1a2e;
				color: #eee;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 40px 20px;
			}
			h1 {
				font-size: 24px;
				font-weight: 300;
				color: #888;
				margin-bottom: 30px;
			}
			.status-card {
				background: #16213e;
				border-radius: 12px;
				padding: 20px;
				margin-bottom: 20px;
				width: 100%;
				max-width: 400px;
			}
			.status-row {
				display: flex;
				justify-content: space-between;
				padding: 8px 0;
				border-bottom: 1px solid #2a2a4a;
			}
			.status-row:last-child {
				border-bottom: none;
			}
			.status-label {
				color: #888;
			}
			.status-value {
				font-weight: 600;
			}
			.status-value.online {
				color: #40916c;
			}
			.status-value.offline {
				color: #e63946;
			}
			.btn {
				padding: 16px 40px;
				font-size: 18px;
				border: none;
				border-radius: 12px;
				cursor: pointer;
				font-weight: 600;
				margin: 10px;
				min-width: 200px;
			}
			.btn-start {
				background: #40916c;
				color: white;
			}
			.btn-start:hover {
				background: #52b788;
			}
			.btn-start:disabled {
				background: #3a3a5a;
				cursor: not-allowed;
			}
			.btn-stop {
				background: #e63946;
				color: white;
			}
			.btn-stop:hover {
				background: #ff6b6b;
			}
			.btn-kick {
				background: #b91c1c;
				color: white;
				min-width: 80px;
				padding: 8px 16px;
				font-size: 14px;
			}
			.btn-kick:hover {
				background: #dc2626;
			}
			.btn-kick:disabled {
				background: #3a3a5a;
				cursor: not-allowed;
			}
			.btn-youtube {
				background: #ff0000;
				color: white;
				min-width: 120px;
				padding: 12px 20px;
				font-size: 14px;
			}
			.btn-youtube:hover {
				background: #cc0000;
			}
			.btn-youtube:disabled {
				background: #3a3a5a;
				cursor: not-allowed;
			}
			.btn-youtube-stop {
				background: #666;
			}
			.btn-youtube-stop:hover {
				background: #888;
			}
			.youtube-status {
				display: flex;
				align-items: center;
				gap: 8px;
			}
			.live-indicator {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				background: #666;
			}
			.live-indicator.live {
				background: #ff0000;
				animation: pulse 1s ease-in-out infinite;
			}
			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}
			.race-time {
				font-size: 48px;
				font-weight: 700;
				font-family: monospace;
				margin: 30px 0;
				color: #40916c;
			}
			.message {
				margin-top: 20px;
				padding: 12px 20px;
				border-radius: 8px;
				background: #2a2a4a;
			}
			.message.success {
				background: #2d6a4f;
			}
			.message.error {
				background: #9d0208;
			}

			/* Token Generator */
			.section-title {
				font-size: 18px;
				font-weight: 300;
				color: #888;
				margin: 40px 0 20px 0;
			}
			.token-card {
				background: #16213e;
				border-radius: 12px;
				padding: 20px;
				width: 100%;
				max-width: 400px;
			}
			.token-row {
				display: flex;
				gap: 10px;
				margin-bottom: 15px;
			}
			.token-select {
				flex: 1;
				padding: 12px;
				font-size: 14px;
				border: 2px solid #3a3a5a;
				border-radius: 8px;
				background: #1a1a2e;
				color: #eee;
			}
			.btn-generate {
				background: #3a3a7a;
				color: white;
				padding: 12px 20px;
				font-size: 14px;
				min-width: auto;
			}
			.btn-generate:hover {
				background: #4a4a9a;
			}
			.token-output {
				background: #1a1a2e;
				border: 2px solid #3a3a5a;
				border-radius: 8px;
				padding: 15px;
				font-family: monospace;
				font-size: 14px;
				word-break: break-all;
				color: #40916c;
				min-height: 50px;
				cursor: pointer;
				position: relative;
			}
			.token-output:hover {
				border-color: #5a5a8a;
			}
			.token-output .hint {
				color: #666;
				font-size: 12px;
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
			}
			.token-expires {
				margin-top: 10px;
				font-size: 12px;
				color: #888;
			}
			.copy-feedback {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: rgba(64, 145, 108, 0.9);
				padding: 8px 16px;
				border-radius: 6px;
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
				animation: fadeOut 1s ease-out forwards;
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				70% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
		</style>
	</head>
	<body>
		<h1>üèéÔ∏è Race Admin</h1>

		<div class="status-card">
			<div class="status-row">
				<span class="status-label">ESP32</span>
				<span id="esp32-status" class="status-value offline">--</span>
			</div>
			<div class="status-row">
				<span class="status-label">Player Connected</span>
				<span style="display: flex; align-items: center; gap: 10px">
					<span id="player-status" class="status-value offline">No</span>
					<button class="btn btn-kick" id="kick-btn" onclick="kickPlayer()" disabled>Kick</button>
				</span>
			</div>
			<div class="status-row">
				<span class="status-label">Video Feed</span>
				<span id="video-status" class="status-value offline">No</span>
			</div>
			<div class="status-row">
				<span class="status-label">Player Ready</span>
				<span id="ready-status" class="status-value offline">No</span>
			</div>
			<div class="status-row">
				<span class="status-label">Throttle Limit</span>
				<span style="display: flex; align-items: center; gap: 10px">
					<input type="range" id="throttle-slider" min="10" max="50" value="25" style="width: 120px" oninput="updateThrottleLabel()" />
					<span id="throttle-value" style="min-width: 40px">25%</span>
					<button class="btn btn-kick" onclick="setThrottle()">Set</button>
				</span>
			</div>
		</div>

		<div class="race-time" id="race-time">00:00.000</div>

		<div>
			<button class="btn btn-start" id="start-btn" onclick="startRace()">Start Race</button>
			<button class="btn btn-stop" id="stop-btn" onclick="stopRace()">Stop</button>
		</div>

		<div id="message" class="message" style="display: none"></div>

		<h2 class="section-title">ÔøΩ YouTube Stream</h2>

		<div class="status-card">
			<div class="status-row">
				<span class="status-label">Stream Status</span>
				<span class="youtube-status">
					<span class="live-indicator" id="youtube-indicator"></span>
					<span id="youtube-status">Offline</span>
				</span>
			</div>
			<div class="status-row" style="justify-content: center; padding-top: 15px">
				<button class="btn btn-youtube" id="youtube-start-btn" onclick="startYouTubeStream()">‚ñ∂ Go Live</button>
				<button class="btn btn-youtube btn-youtube-stop" id="youtube-stop-btn" onclick="stopYouTubeStream()" disabled>‚èπ Stop</button>
			</div>
		</div>

		<h2 class="section-title">ÔøΩüîë Token Generator</h2>

		<div class="token-card">
			<div class="token-row">
				<select id="token-duration" class="token-select">
					<option value="15">15 minutes</option>
					<option value="30">30 minutes</option>
					<option value="60" selected>1 hour</option>
					<option value="120">2 hours</option>
					<option value="480">8 hours</option>
					<option value="1440">24 hours</option>
				</select>
				<button class="btn btn-generate" onclick="generateToken()">Generate</button>
			</div>
			<div id="token-output" class="token-output" onclick="copyToken()">
				<span class="hint">Click "Generate" to create a token</span>
			</div>
			<div id="token-expires" class="token-expires"></div>
		</div>

		<!-- Optional: Load config.js for deployment-specific URLs -->
		<script src="config.js" onerror="console.log('No config.js found, using defaults')"></script>

		<script>
			// Control Relay URL (via Cloudflare Tunnel in production)
			const CONTROL_URL = window.CONTROL_URL || '';

			// YouTube Restreamer (Fly.io)
			const RESTREAMER_URL = window.RESTREAMER_URL || '';
			const RESTREAMER_SECRET = window.RESTREAMER_SECRET || '';

			let raceStartTime = null;
			let timerInterval = null;
			let youtubeStreaming = false;

			let throttleInitialized = false; // Only set slider from server once on load

			// ===== YouTube Streaming =====
			async function updateYouTubeStatus() {
				try {
					const res = await fetch(`${RESTREAMER_URL}/status`);
					const data = await res.json();
					youtubeStreaming = data.streaming;

					document.getElementById('youtube-status').textContent = data.streaming ? 'LIVE' : 'Offline';
					document.getElementById('youtube-indicator').className = 'live-indicator' + (data.streaming ? ' live' : '');
					document.getElementById('youtube-start-btn').disabled = data.streaming;
					document.getElementById('youtube-stop-btn').disabled = !data.streaming;
				} catch (e) {
					document.getElementById('youtube-status').textContent = 'Error';
					console.error('YouTube status error:', e);
				}
			}

			async function startYouTubeStream() {
				if (!RESTREAMER_SECRET) {
					showMessage('RESTREAMER_SECRET not configured', true);
					return;
				}

				document.getElementById('youtube-start-btn').disabled = true;
				document.getElementById('youtube-status').textContent = 'Starting...';

				try {
					const res = await fetch(`${RESTREAMER_URL}/start`, {
						method: 'POST',
						headers: { Authorization: `Bearer ${RESTREAMER_SECRET}` },
					});
					const data = await res.json();

					if (data.started) {
						showMessage('YouTube stream started!');
						setTimeout(updateYouTubeStatus, 2000);
					} else {
						showMessage(data.error || 'Failed to start stream', true);
						updateYouTubeStatus();
					}
				} catch (e) {
					showMessage('Failed to start YouTube stream: ' + e.message, true);
					updateYouTubeStatus();
				}
			}

			async function stopYouTubeStream() {
				if (!RESTREAMER_SECRET) {
					showMessage('RESTREAMER_SECRET not configured', true);
					return;
				}

				document.getElementById('youtube-stop-btn').disabled = true;
				document.getElementById('youtube-status').textContent = 'Stopping...';

				try {
					const res = await fetch(`${RESTREAMER_URL}/stop`, {
						method: 'POST',
						headers: { Authorization: `Bearer ${RESTREAMER_SECRET}` },
					});
					const data = await res.json();

					if (data.stopped) {
						showMessage('YouTube stream stopped');
					}
					setTimeout(updateYouTubeStatus, 1000);
				} catch (e) {
					showMessage('Failed to stop YouTube stream: ' + e.message, true);
					updateYouTubeStatus();
				}
			}

			async function updateStatus() {
				try {
					const res = await fetch(`${CONTROL_URL}/control/health`);
					const data = await res.json();

					document.getElementById('esp32-status').textContent = data.esp32_ip || 'Not found';
					document.getElementById('esp32-status').className = 'status-value ' + (data.esp32_ip ? 'online' : 'offline');

					document.getElementById('player-status').textContent = data.channel_open ? 'Yes' : 'No';
					document.getElementById('player-status').className = 'status-value ' + (data.channel_open ? 'online' : 'offline');

					document.getElementById('video-status').textContent = data.video_connected ? 'Yes' : 'No';
					document.getElementById('video-status').className = 'status-value ' + (data.video_connected ? 'online' : 'offline');

					document.getElementById('ready-status').textContent = data.player_ready ? 'Yes' : 'No';
					document.getElementById('ready-status').className = 'status-value ' + (data.player_ready ? 'online' : 'offline');

					// Only initialize throttle slider once from server (not on every poll)
					if (!throttleInitialized && data.throttle_limit !== undefined) {
						const pct = Math.round(data.throttle_limit * 100);
						document.getElementById('throttle-slider').value = pct;
						document.getElementById('throttle-value').textContent = pct + '%';
						throttleInitialized = true;
					}

					// Only enable start when player is ready (has video + clicked ready)
					document.getElementById('start-btn').disabled = !data.player_ready;
					document.getElementById('kick-btn').disabled = !data.channel_open;
				} catch (e) {
					console.error('Status check failed:', e);
				}
			}

			function updateThrottleLabel() {
				const val = document.getElementById('throttle-slider').value;
				document.getElementById('throttle-value').textContent = val + '%';
			}

			async function setThrottle() {
				const val = parseInt(document.getElementById('throttle-slider').value);
				try {
					const res = await fetch(`${CONTROL_URL}/admin/set-throttle`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ limit: val / 100 }),
					});
					const data = await res.json();
					if (data.success) {
						showMessage(`Throttle set to ${val}%`);
					} else {
						showMessage(data.error || 'Failed to set throttle', true);
					}
				} catch (e) {
					showMessage('Failed to set throttle: ' + e.message, true);
				}
			}

			function showMessage(text, isError = false) {
				const msg = document.getElementById('message');
				msg.textContent = text;
				msg.className = 'message ' + (isError ? 'error' : 'success');
				msg.style.display = 'block';
				setTimeout(() => (msg.style.display = 'none'), 3000);
			}

			function updateTimer() {
				if (!raceStartTime) return;
				const elapsed = Date.now() - raceStartTime;
				const mins = Math.floor(elapsed / 60000);
				const secs = Math.floor((elapsed % 60000) / 1000);
				const ms = elapsed % 1000;
				document.getElementById('race-time').textContent =
					String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0') + '.' + String(ms).padStart(3, '0');
			}

			async function startRace() {
				try {
					const res = await fetch(`${CONTROL_URL}/admin/start-race`, { method: 'POST' });
					const data = await res.json();

					if (data.success) {
						showMessage('Race countdown started!');
						// Start timer after 3 second countdown
						setTimeout(() => {
							raceStartTime = Date.now();
							timerInterval = setInterval(updateTimer, 50);
						}, 3000);
					} else {
						showMessage(data.error || 'Failed to start race', true);
					}
				} catch (e) {
					showMessage('Failed to start race: ' + e.message, true);
				}
			}

			async function stopRace() {
				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}

				try {
					const res = await fetch(`${CONTROL_URL}/admin/stop-race`, { method: 'POST' });
					showMessage('Race stopped');
				} catch (e) {
					console.error('Stop race error:', e);
				}
			}
			async function kickPlayer() {
				if (!confirm('Kick player and revoke their token?')) return;

				// Stop timer if running
				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}
				raceStartTime = null;
				document.getElementById('race-time').textContent = '00:00.000';

				try {
					const res = await fetch(`${CONTROL_URL}/admin/kick-player`, { method: 'POST' });
					const data = await res.json();

					if (data.success) {
						showMessage('Player kicked & token revoked');
						updateStatus(); // Refresh status immediately
					} else {
						showMessage(data.error || 'Failed to kick player', true);
					}
				} catch (e) {
					showMessage('Failed to kick player: ' + e.message, true);
				}
			}
			// Update status every 2 seconds
			updateStatus();
			setInterval(updateStatus, 2000);

			// Update YouTube status every 5 seconds
			updateYouTubeStatus();
			setInterval(updateYouTubeStatus, 5000);

			// ===== Token Generator =====
			let currentToken = null;

			async function generateToken() {
				const minutes = parseInt(document.getElementById('token-duration').value);
				const outputEl = document.getElementById('token-output');
				const expiresEl = document.getElementById('token-expires');

				outputEl.innerHTML = '<span class="hint">Generating...</span>';
				expiresEl.textContent = '';

				try {
					const res = await fetch('/admin/generate-token', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ minutes }),
					});

					if (!res.ok) {
						throw new Error('Failed to generate token');
					}

					const data = await res.json();
					currentToken = data.token;
					outputEl.textContent = data.token;

					const expiresDate = new Date(data.expiresAt);
					expiresEl.textContent = `Expires: ${expiresDate.toLocaleString()}`;
				} catch (e) {
					outputEl.innerHTML = '<span class="hint" style="color: #e63946;">Error generating token</span>';
					console.error('Token generation error:', e);
				}
			}

			function copyToken() {
				if (!currentToken) return;

				navigator.clipboard.writeText(currentToken).then(() => {
					const outputEl = document.getElementById('token-output');
					const feedback = document.createElement('div');
					feedback.className = 'copy-feedback';
					feedback.textContent = 'Copied!';
					outputEl.appendChild(feedback);
					setTimeout(() => feedback.remove(), 1000);
				});
			}
		</script>
	</body>
</html>
