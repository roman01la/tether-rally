# =============================================================================
# ARRMA Big Rock 3S - Badlands Tires (130mm) + 4.2kg Weight Profile
# =============================================================================
#
# Hardware:
#   Tires: Horizon Hobby Badlands MX38 HP (130mm diameter)
#   Weight: 4.2kg total (3.75kg car + 0.45kg battery)
#   ESC: Spektrum Firma 3660 3200Kv brushless
#   Drivetrain: 4WD, 10.83:1 final drive
#
# Characteristics:
#   - Better grip than stock Ragnarok tires
#   - Larger diameter = higher top speed, slightly slower acceleration
#   - Heavier weight = more inertia, better stability, longer braking
#
# Tuning Philosophy:
#   - Allow controlled wheelspin for fun launches
#   - Gentle stability intervention (not a nanny)
#   - Fast recovery to maintain responsive feel
#
# =============================================================================

[vehicle]
# Physical vehicle parameters - MUST match actual hardware
wheel_diameter_mm = 130          # Tire outer diameter (mm) - affects speed calculation
weight_kg = 4.2                  # Total weight with battery (kg) - affects hill hold
wheelbase_m = 0.32               # Wheel center to wheel center (m) - affects yaw model
max_steering_angle_deg = 30.0    # Max front wheel angle at full servo (deg)

[heading_blend]
# Blends IMU heading (fast, drifts) with GPS heading (slow, accurate)
# At low speed GPS heading is noisy, at high speed it's reliable
imu_only_speed_kmh = 5.0         # Below this: 100% IMU heading
gps_blend_speed_kmh = 15.0       # Above this: blend toward GPS
heading_smooth_alpha = 0.3       # Low-pass filter (0.1=smooth, 0.5=responsive)
imu_mount_offset_deg = 9.0       # Add to IMU to align with car forward (calibrated)

[speed_fusion]
# Fuses wheel sensor + IMU + GPS into reliable speed estimate
# Wheel sensor is primary, IMU fills gaps, GPS corrects drift
fusion_alpha = 0.15              # Smoothing for speed transitions (lower=smoother)
imu_integrate_rate = 0.8         # Trust in IMU integration per cycle (0-1)
gps_drift_correction_alpha = 0.25  # GPS drift correction strength (0-1)
gps_drift_correction_min_speed_kmh = 5.0  # Only correct above this speed
wheelspin_detect_ratio = 1.5     # wheel/GPS ratio indicating wheelspin
wheelspin_detect_time_s = 0.3    # Sustained time before wheelspin confirmed
wheelspin_max_fused_ratio = 1.2  # Cap fused speed during wheelspin
stationary_timeout_s = 3.0       # Seconds stopped before decay kicks in
stationary_decay_rate = 0.5      # Speed decay rate when stationary (per sec)
imu_accel_noise_threshold = 0.3  # Ignore IMU accel below this (m/s²)

[low_speed_traction]
# Unified traction control: launch (proactive) + cruise (reactive)
# Launch phase: Target optimal slip for maximum acceleration
# Cruise phase: Only intervene on excessive wheelspin

# Phase boundaries
launch_phase_end_kmh = 5.0       # End of launch phase (proactive control)
transition_phase_end_kmh = 15.0  # End of transition, start pure cruise

# Launch phase (0-5 km/h) - proactive slip targeting
launch_target_slip = 0.07        # Target slip ratio (7% = good traction)
launch_slip_tolerance = 0.03     # ±3% tolerance around target
launch_max_throttle_rate = 400   # Max throttle increase per cycle (~1.6s to full at 50Hz)
launch_throttle_ceiling = 850    # Max throttle during launch (out of 1000)
launch_slip_high_cut = 0.8       # Throttle multiplier when slip too high

# Cruise phase (>15 km/h) - reactive slip correction
cruise_slip_threshold = 0.15     # 15% slip triggers intervention (lower=stricter)
cruise_throttle_cut_rate = 0.05  # How fast to cut throttle on slip
cruise_recovery_rate = 0.08      # How fast to recover when grip returns
cruise_min_multiplier = 0.50     # Never cut below 50% throttle

# Shared
min_throttle_for_slip = 100      # Minimum throttle to consider slip detection
yaw_rate_threshold = 90.0        # deg/s - reduce sensitivity in tight turns
accel_smoothing = 0.3            # EMA alpha for acceleration smoothing
gps_drift_correction_alpha = 0.01  # Very slow GPS correction for ground speed
gps_drift_correction_min_speed_kmh = 5.0

[yaw_rate_controller]
# ESC-lite stability control using bicycle model
# Compares actual yaw rate to expected (from speed + steering)
# Oversteer = car rotating too fast, Understeer = not rotating enough

grip_factor = 0.50               # Real yaw vs kinematic ideal (0.3=loose, 0.7=grippy)
min_speed_kmh = 5.0              # Disabled below this (allow tight maneuvers)

# Thresholds (deg/s error from expected)
oversteer_threshold = 28.0       # Error above this = oversteer (lower=stricter)
understeer_threshold = 20.0      # Error below this = understeer

# Intervention rates (per update cycle at ~20Hz)
oversteer_cut_rate = 0.025       # Throttle cut rate on oversteer
understeer_cut_rate = 0.015      # Throttle cut rate on understeer (gentler)
min_throttle_mult = 0.50         # Never cut below 50%

# Recovery
recovery_rate = 0.05             # Normal recovery rate
fast_recovery_rate = 0.10        # Fast recovery when clearly stable

# Virtual brake (additional braking on severe oversteer)
virtual_brake_enabled = true
virtual_brake_threshold = 50.0   # deg/s error triggers brake
max_virtual_brake = 400          # Max brake command (0-1000)

yaw_smoothing = 0.2              # EMA alpha for yaw rate smoothing

[slip_angle_watchdog]
# Detects sliding/drifting using lateral acceleration
# Expected lateral accel = speed × yaw_rate
# Excess = actual - expected = sliding

min_speed_kmh = 5.0              # Disabled below this
lateral_excess_threshold = 4.0   # m/s² excess triggers detection (lower=stricter)
slip_duration_threshold_s = 0.20 # 200ms sustained slip before intervention
min_throttle_for_intervention = 300  # Minimum throttle to intervene

# Throttle control
recovery_target = 0.6            # Target multiplier during recovery (60%)
reduction_rate = 0.05            # How fast to reduce on slip
recovery_rate = 0.08             # How fast to recover
min_multiplier = 0.5             # Floor at 50%

smoothing_alpha = 0.3            # Lateral accel smoothing

[surface_adaptation]
# Estimates grip from driving behavior (lateral accel vs steering)
# Outputs multiplier that scales other controllers' thresholds

min_speed_kmh = 10.0             # Only measure above this
min_steering = 200               # Minimum steering input to measure
min_samples = 10                 # Samples needed before outputting estimate

default_grip = 0.85              # Starting assumption (Badlands = grippy)
grip_smoothing = 0.05            # EMA alpha for grip updates (slow)
grip_min = 0.2                   # Minimum grip estimate
grip_max = 1.2                   # Maximum grip (>1 = very grippy surface)
history_size = 50                # Rolling average window

[hill_hold]
# Prevents rollback on slopes when throttle released
# Uses pitch from IMU to detect incline and apply counter-throttle

# Detection
pitch_threshold_deg = 10.0       # Minimum incline to activate (degrees, higher to avoid chassis tilt)
speed_threshold_kmh = 2.0        # Must be nearly stopped
throttle_deadzone = 100          # Ignore throttle input below this

# Hold force (tuned for 4.2kg weight)
hold_strength = 37               # Throttle units per degree of pitch
max_hold_force = 500             # Maximum hold throttle (clamp)

# Release
immediate_release_threshold = 300  # Throttle above this = instant release
blend_rate = 0.15                # Blend speed when releasing (0-1 per cycle)
timeout_s = 30.0                 # Auto-release after this long
settling_time_s = 0.5            # Time car must be stationary before activation

[abs]
# Anti-lock braking - prevents wheel lockup during forward braking
# Pulses brake to maintain steering control

slip_threshold = 0.18            # 18% slip triggers ABS (higher for grippy tires)
min_speed_kmh = 3.0              # Disabled below this
min_brake_input = 100            # Minimum brake to activate

# Direction detection (forward vs reverse)
direction_hysteresis_kmh = 1.0   # Prevents direction flapping
accel_direction_threshold = 0.5  # m/s² for low-speed direction detection

# ABS cycling
cycle_time_ms = 50               # Pulse period (20 Hz)
brake_apply_ratio = 0.6          # Brake pressure during "apply" phase
brake_release_ratio = 0.2        # Brake pressure during "release" phase

[coast_control]
# Smooths transition from throttle to coast
# Counteracts ESC's aggressive drag brake

release_threshold_high = 100     # Throttle was above this...
release_threshold_low = 50       # ...and dropped below this = release detected
coast_duration_s = 0.3           # Duration of coast assist
coast_throttle = 100             # Initial counter-throttle (decays to 0)
min_speed_kmh = 5.0              # Disabled below this

[steering_shaper]
# Makes steering drivable over 100-200ms internet latency
# Limits steering at speed, rate-limits changes, assists counter-steer

# Speed-based steering limit
max_steering_ratio = 1.0         # 100% steering at low speed
min_steering_ratio = 0.5         # 50% steering at high speed
low_speed_kmh = 8.0              # Below this: full steering
high_speed_kmh = 40.0            # Above this: minimum steering

# Rate limiting (prevents snap-oversteer from delayed input)
max_rate = 300000                # Max steering change per second (units/sec)
center_rate = 400000             # Faster rate for returning to center

# Counter-steer assist (helps save slides)
counter_steer_enabled = true
counter_steer_min_yaw = 20.0     # deg/s rotation to trigger assist
counter_steer_strength = 0.10   # 10% of ideal counter-steer (subtle hint)
counter_steer_max_input = 5000   # Only assist when input near neutral
counter_steer_min_speed_kmh = 10.0  # Disabled below this
counter_steer_max_amount = 5000  # Maximum assist amount

smoothing_alpha = 0.7            # Output smoothing (higher=responsive)

[direction_estimator]
# Estimates vehicle direction (forward/backward) without directional sensor
# Fuses IMU acceleration + throttle intent + yaw-steering correlation

# Seeding thresholds (from standstill)
throttle_seed_threshold = 200    # Throttle (0-1000 scale) to seed direction
accel_confirm_threshold = 0.5    # m/s² to confirm throttle intent

# Speed thresholds
stopped_threshold_ms = 0.5       # m/s - below this = stopped
yaw_validation_min_speed_ms = 1.0  # m/s - need speed for yaw validation

# Yaw-steering correlation validation
min_steering_for_validation = 5000   # ~15% of full lock (0-32767 scale)
min_yaw_rate_for_validation = 20.0   # deg/s minimum to validate
yaw_correction_min_speed_ms = 1.5    # m/s - trust yaw correction above this
yaw_correction_min_yaw_rate = 30.0   # deg/s - trust yaw when rate exceeds this

# Drift correction
stationary_decay_rate = 0.85     # Decay factor per cycle when stationary
stationary_accel_threshold = 0.3 # m/s² noise floor
stationary_throttle_threshold = 100  # Throttle below this = released (0-1000)

# IMU bias estimation (high-pass filter)
bias_learning_rate = 0.001       # How fast to estimate accelerometer bias

# Confidence tracking
confidence_decay_on_disagreement = 0.9   # Decay when yaw disagrees with IMU
confidence_decay_when_stationary = 0.95  # Decay when stopped
confidence_growth_rate = 0.1             # Growth per cycle when moving
